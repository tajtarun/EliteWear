document.getElementById("submitAll").onclick = async () => {
  statusBox.innerHTML = "";
  const rows = [...rowsContainer.children];
  const fd = new FormData();
  let valid = false;

  rows.forEach(row => {
    const file = row.querySelector("input[type=file]").files[0];
    const name = row.querySelector("input[placeholder='Product Name']").value.trim();
    const price = row.querySelector("input[placeholder='Price â‚¹']").value.trim();

    if (file && name && price) {
      fd.append("files", file);
      fd.append("names[]", name);
      fd.append("prices[]", price);
      valid = true;
    }
  });

  if (!valid) {
    statusBox.innerHTML = `<div class="status error">Please fill at least one complete item.</div>`;
    return;
  }

  statusBox.innerHTML = `<div class="status">Sending...</div>`;

  try {
    const res = await fetch(ENDPOINT, {
      method: "POST",
      body: fd
    });

    console.log("Response status:", res.status);

    if (!res.ok) {
      throw new Error("Server responded with error");
    }

    const data = await res.json();
    console.log("Response data:", data);

    if (data.success) {
      window.location.href = "thankyou-consignment.html";
    } else {
      throw new Error("Email failed");
    }

  } catch (error) {
    console.error("Submission error:", error);
    statusBox.innerHTML = `<div class="status error">Submission failed. Check console.</div>`;
  }
};
