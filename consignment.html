<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Consignment Upload — EliteWear</title>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<style>
  /* Minimal luxurious gold/black UI */
  :root{--gold:#d4af37;--bg:#070707;--card:#0f0f0f;--muted:#2b2b2b}
  body{margin:0;background:var(--bg);color:#fff;font-family:Poppins,system-ui,Arial;padding:30px;display:flex;justify-content:center}
  .wrap{max-width:980px;width:100%;display:flex;gap:28px}
  .left{width:42%;display:flex;flex-direction:column;gap:12px}
  .upload-box{height:360px;background:var(--card);border-radius:16px;border:3px dashed var(--gold);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden}
  .plus{font-size:72px;color:var(--gold);animation:glow 1.4s infinite alternate}
  @keyframes glow{from{text-shadow:0 0 8px var(--gold)}to{text-shadow:0 0 26px var(--gold)}}
  .preview{width:100%;height:100%;object-fit:cover;display:none}

  .right{width:58%;background:var(--card);padding:22px;border-radius:14px;border:2px solid rgba(255,215,0,0.12);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  label{display:block;color:var(--gold);font-weight:700;margin-top:12px}
  input[type=text], input[type=number], input[type=email], textarea{
    width:100%;padding:12px;border-radius:10px;background:#171717;border:1px solid #222;color:#fff;margin-top:6px;box-sizing:border-box;font-size:14px
  }
  textarea{height:120px;resize:vertical}
  .row{display:flex;gap:12px}
  .col{flex:1}

  .submit{display:block;margin-top:18px;background:linear-gradient(90deg,#b8860b,#ffd700);color:#000;padding:14px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
  .loading{display:none;color:var(--gold);margin-top:12px;text-align:center}
  .hint{font-size:13px;color:#ccc;margin-top:8px}
  .small{font-size:13px;color:#aaa}
  /* responsive */
  @media (max-width:880px){.wrap{flex-direction:column}.left,.right{width:100%}}
</style>
</head>
<body>

<div class="wrap">

  <!-- LEFT: image upload -->
  <div class="left">
    <div class="upload-box" id="uploadBox" onclick="document.getElementById('product_image').click()">
      <span class="plus" id="plusIcon">+</span>
      <img id="previewImage" class="preview" alt="preview">
    </div>
    <div class="hint">Click the box to choose an image (will be uploaded to Supabase and attached to the email).</div>
    <input id="product_image" type="file" accept="image/*" style="display:none">
  </div>

  <!-- RIGHT: fields -->
  <form id="consignmentForm" class="right" autocomplete="off">
    <h2 style="margin:0 0 8px 0;color:var(--gold)">Submit Your Product for Consignment</h2>

    <label>Product Name *</label>
    <input id="product_name" type="text" placeholder="e.g. Leather Jacket" required>

    <label>Product Price *</label>
    <input id="product_price" type="number" placeholder="e.g. 1299" required>

    <label>Your Email (used as reply-to) *</label>
    <input id="user_email" type="email" placeholder="you@example.com" required>

    <label>Your Name</label>
    <input id="user_name" type="text" placeholder="Your name (optional)">

    <button class="submit" type="submit">Submit Consignment</button>

    <div id="loadingSpinner" class="loading">Uploading &amp; sending — please wait…</div>
    <div class="small">Phones & Gmail sometimes hide remote images until you click "Show images" in the mail.</div>
  </form>

</div>

<script>
/* ===========================
   CONFIG - replace only if needed
   (I used the keys/IDs you already provided)
   =========================== */
emailjs.init("ZOt4YXfU6cDioZWJG"); // EmailJS public key

const EMAILJS_SERVICE_ID = "service_f8g34x6";
const EMAILJS_TEMPLATE_ID = "template_trg9yth";

const SUPABASE_URL = "https://eonwirzbhwcpfqiltyjp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvbndpcnpiaHdjcGZxaWx0eWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTYwNjksImV4cCI6MjA3OTczMjA2OX0.kT-pqelZyTfiaoaKSbSqFLPW7xwbemZ2V4Y-WpyHN8Q";
const BUCKET = "product-images";

/* -------------------------
   INIT SUPABASE CLIENT
--------------------------*/
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------------
   DOM refs
--------------------------*/
const productImageInput = document.getElementById('product_image');
const previewImage = document.getElementById('previewImage');
const plusIcon = document.getElementById('plusIcon');
const uploadBox = document.getElementById('uploadBox');
const form = document.getElementById('consignmentForm');
const loadingSpinner = document.getElementById('loadingSpinner');

/* -------------------------
   Image preview
--------------------------*/
productImageInput.addEventListener('change', () => {
  const f = productImageInput.files[0];
  if (!f) return;
  previewImage.src = URL.createObjectURL(f);
  previewImage.style.display = 'block';
  plusIcon.style.display = 'none';
});

/* -------------------------
   Helper: show/hide loading
--------------------------*/
function showLoading(show){
  loadingSpinner.style.display = show ? 'block' : 'none';
}

/* -------------------------
   Submit handler
--------------------------*/
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  showLoading(true);

  const productName = document.getElementById('product_name').value.trim();
  const productPrice = document.getElementById('product_price').value.trim();
  const userEmail = document.getElementById('user_email').value.trim();
  const userName = document.getElementById('user_name').value.trim();
  const file = productImageInput.files[0];

  if (!productName || !productPrice || !userEmail || !file) {
    alert('Please fill required fields and choose an image.');
    showLoading(false);
    return;
  }

  try {
    // 1) Upload image to Supabase storage
    const fileName = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
    const up = await supabase.storage.from(BUCKET).upload(fileName, file);

    if (up.error) throw up.error;

    // 2) Get public URL
    const { data: pub } = await supabase.storage.from(BUCKET).getPublicUrl(fileName);
    const imageUrl = pub.publicUrl;

    // 3) Insert record (optional)
    const { error: insertError } = await supabase.from('products').insert([{
      product_name: productName,
      product_price: productPrice,
      image_url: imageUrl,
      user_email: userEmail,
      user_name: userName || null
    }]);
    if (insertError) console.warn('DB insert warning:', insertError);

    // 4) Send email via EmailJS
    // NOTE: template must use {{attachment}} for image
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      product_name: productName,
      product_price: productPrice,
      user_email: userEmail,
      user_name: userName,
      attachment: imageUrl,     // <--- template must use {{attachment}}
      year: new Date().getFullYear()
    });

    // 5) Redirect to thank you
    window.location.href = 'thankyou-consignment.html';

  } catch (err) {
    console.error(err);
    alert('Error submitting. Open DevTools console (F12) and check the error.');
  } finally {
    showLoading(false);
  }
});
</script>

</body>
</html>
