<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Consignment — EliteWear</title>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{--bg:#050505;--card:#0f0f0f;--gold:#d4af37;--muted:#bfb8ad}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:'Poppins',sans-serif;padding:36px}
.container{max-width:1100px;margin:0 auto}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
.title{font-size:22px;color:var(--gold);font-weight:700}
.lead{color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:420px 1fr;gap:22px}
.card{background:var(--card);border-radius:14px;padding:18px;border:1px solid rgba(212,175,55,0.06)}
.upload-box{height:360px;border-radius:12px;border:3px dashed rgba(212,175,55,0.6);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;background:linear-gradient(180deg,#070707,#111)}
.plus{font-size:88px;color:var(--gold);animation:glow 1.4s infinite alternate}
@keyframes glow{from{text-shadow:0 0 10px rgba(212,175,55,0.2)}to{text-shadow:0 0 28px rgba(212,175,55,0.4)}}
.preview{width:100%;height:100%;object-fit:cover;display:none;border-radius:10px}

/* right column form layout */
.right-form { display:flex; flex-direction:column; gap:12px; }
.row-list { display:flex; flex-direction:column; gap:14px; margin-top:10px; }
.row-item { display:flex; gap:12px; align-items:flex-start; background:#0b0b0b;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02) }
.row-upload { width:140px; height:120px; border-radius:10px; border:2px dashed rgba(212,175,55,0.45); display:flex;align-items:center;justify-content:center; cursor:pointer; overflow:hidden; background:#080808; }
.row-upload img{width:100%;height:100%;object-fit:cover;display:none}
.row-fields{flex:1; display:flex; flex-direction:column; gap:8px}
label{color:var(--gold);font-weight:600;font-size:13px}
input[type="text"], input[type="number"], input[type="email"]{width:100%;padding:10px;border-radius:8px;border:none;background:#111;color:#fff}
.small{font-size:12px;color:var(--muted)}

/* buttons */
.controls{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-top:12px}
.btn { padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer }
.btn.gold { background:linear-gradient(90deg,#b8860b,#ffd54a); color:#000 }
.btn.ghost { background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04) }

/* submit area */
.footer{display:flex;justify-content:space-between;align-items:center;margin-top:18px}
.submit { padding:12px 20px;border-radius:12px;border:none;background:var(--gold);color:#000;font-weight:800;cursor:pointer }

/* responsive */
@media (max-width:980px){
  .grid{grid-template-columns:1fr; }
  .upload-box{height:260px}
  .row-upload{width:120px;height:100px}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <div class="title">EliteWear — Consignment</div>
      <div class="lead">Add your luxury items. Upload image on left, enter product name & price on the right. Add unlimited rows.</div>
    </div>
    <div class="small">You will be redirected to a thank you page after submission.</div>
  </div>

  <div class="grid">
    <!-- LEFT: big upload + preview (this is a global preview for the selected row) -->
    <div class="card">
      <div id="bigUpload" class="upload-box" title="Click to choose image (for the active row)">
        <span id="bigPlus" class="plus">+</span>
        <img id="bigPreview" class="preview" alt="preview">
      </div>
      <div class="small" style="margin-top:12px">Click the upload box for the currently active row (active row is the one highlighted on the right). You can also click each row's upload area to select image specific to that row.</div>
    </div>

    <!-- RIGHT: form + cloned rows -->
    <div class="card right-form">
      <div>
        <label>Your Name *</label>
        <input id="user_name" type="text" placeholder="Your full name" required>

        <label style="margin-top:8px">Your Gmail *</label>
        <input id="user_email" type="email" placeholder="you@example.com" required>
      </div>

      <div style="margin-top:6px; display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:700;color:var(--gold)">Products</div>
        <div style="display:flex;gap:8px">
          <button id="addRowBtn" class="btn gold">+ Add Product</button>
          <button id="clearBtn" class="btn ghost">Clear</button>
        </div>
      </div>

      <div id="rows" class="row-list" aria-live="polite"></div>

      <div class="footer">
        <div class="small">Make sure your Gmail is correct. Images are hosted publicly.</div>
        <button id="submitBtn" class="submit">Submit All</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ======================
   CONFIG — change only here if needed
   ====================== */
emailjs.init("ZOt4YXfU6cDioZWJG"); // your EmailJS public key
const EMAILJS_SERVICE_ID = "service_f8g34x6";
const EMAILJS_TEMPLATE_ID = "template_trg9yth";

const SUPABASE_URL = "https://eonwirzbhwcpfqiltyjp.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvbndpcnpiaHdjcGZxaWx0eWpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTYwNjksImV4cCI6MjA3OTczMjA2OX0.kT-pqelZyTfiaoaKSbSqFLPW7xwbemZ2V4Y-WpyHN8Q";
const BUCKET = "product-images";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ======================
   UI & state
   ====================== */
const rowsEl = document.getElementById('rows');
const addRowBtn = document.getElementById('addRowBtn');
const clearBtn = document.getElementById('clearBtn');
const submitBtn = document.getElementById('submitBtn');
const bigUpload = document.getElementById('bigUpload');
const bigPlus = document.getElementById('bigPlus');
const bigPreview = document.getElementById('bigPreview');

let activeRowId = null;
let nextId = 0;
const rows = []; // will hold objects {id, file, name, price}

/* -------------------
   helpers
   ------------------- */
function createRowNode(id){
  const container = document.createElement('div');
  container.className = 'row-item';
  container.id = 'row-'+id;

  container.innerHTML = `
    <div class="row-upload" id="upload-${id}" title="Click to upload image for this product">
      <span class="plus" id="plus-${id}">+</span>
      <img id="img-${id}" alt="preview">
      <input id="file-${id}" type="file" accept="image/*" style="display:none">
    </div>

    <div class="row-fields">
      <label>Product Name</label>
      <input id="name-${id}" type="text" placeholder="e.g. Vintage Watch" required>

      <div style="display:flex;gap:10px;margin-top:8px">
        <div style="flex:1">
          <label>Price ₹</label>
          <input id="price-${id}" type="number" placeholder="e.g. 1200" required>
        </div>
        <div style="width:90px; display:flex; align-items:flex-end; gap:8px;">
          <button type="button" id="setActive-${id}" class="btn ghost">Select</button>
          <button type="button" id="remove-${id}" class="btn ghost">Remove</button>
        </div>
      </div>
    </div>
  `;

  // event wiring after insertion
  rowsEl.appendChild(container);

  // upload box click -> file input
  const upl = document.getElementById('upload-'+id);
  const fileInput = document.getElementById('file-'+id);
  const previewImg = document.getElementById('img-'+id);
  const plusIcon = document.getElementById('plus-'+id);

  upl.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', () => {
    const f = fileInput.files[0];
    if (!f) return;
    rows.find(r=>r.id===id).file = f;
    previewImg.src = URL.createObjectURL(f);
    previewImg.style.display = 'block';
    plusIcon.style.display = 'none';
    // if this is active row reflect into big preview
    if(activeRowId === id){
      bigPreview.src = previewImg.src;
      bigPreview.style.display = 'block';
      bigPlus.style.display = 'none';
    }
  });

  // set active row button
  document.getElementById('setActive-'+id).addEventListener('click', () => {
    setActiveRow(id);
  });

  // remove
  document.getElementById('remove-'+id).addEventListener('click', () => {
    removeRow(id);
  });

  // text inputs update state
  document.getElementById('name-'+id).addEventListener('input', (e)=> {
    rows.find(r=>r.id===id).name = e.target.value;
  });
  document.getElementById('price-'+id).addEventListener('input', (e)=> {
    rows.find(r=>r.id===id).price = e.target.value;
  });
}

function addNewRow(prefill){
  nextId++;
  const id = nextId;
  rows.push({ id, file: null, name: prefill?.name || '', price: prefill?.price || '' });
  createRowNode(id);
  // prefill values if provided
  if(prefill){
    document.getElementById('name-'+id).value = prefill.name || '';
    document.getElementById('price-'+id).value = prefill.price || '';
  }
  setActiveRow(id);
}

function setActiveRow(id){
  activeRowId = id;
  // highlight active
  document.querySelectorAll('.row-item').forEach(el=>{
    el.style.boxShadow = (el.id === 'row-'+id) ? '0 0 18px rgba(212,175,55,0.18)' : 'none';
  });
  // set big preview if row has file
  const r = rows.find(x=>x.id===id);
  if(r && r.file){
    bigPreview.src = URL.createObjectURL(r.file);
    bigPreview.style.display = 'block';
    bigPlus.style.display = 'none';
  } else {
    bigPreview.style.display = 'none';
    bigPlus.style.display = 'block';
  }
}

function removeRow(id){
  const idx = rows.findIndex(r=>r.id===id);
  if(idx>-1) rows.splice(idx,1);
  const el = document.getElementById('row-'+id);
  if(el) el.remove();
  // set active to first row if exists
  if(rows.length) setActiveRow(rows[0].id);
  else addNewRow();
}

/* initial */
addRowBtn.addEventListener('click', ()=> addNewRow());
clearBtn.addEventListener('click', ()=> {
  rowsEl.innerHTML = '';
  rows.length = 0;
  nextId = 0;
  addNewRow();
});

/* big upload: clicking big box triggers file input of active row */
bigUpload.addEventListener('click', ()=>{
  if(!activeRowId) return;
  const fileInput = document.getElementById('file-'+activeRowId);
  if(fileInput) fileInput.click();
});

/* =========================
   Submit: upload all files and send EmailJS
   ========================= */
submitBtn.addEventListener('click', async () => {
  // validation: user name + email + each row fields + file
  const userName = document.getElementById('user_name').value.trim();
  const userEmail = document.getElementById('user_email').value.trim();
  if(!userName || !userEmail) { alert('Please provide your name and email'); return; }
  if(rows.length===0){ alert('Add at least one product'); return; }

  // validate each row fields
  for(const r of rows){
    const nameEl = document.getElementById('name-'+r.id);
    const priceEl = document.getElementById('price-'+r.id);
    if(!nameEl || !priceEl){ alert('Row inputs missing'); return; }
    if(!nameEl.value.trim() || !priceEl.value.trim()){ alert('Please fill name and price for every product'); return; }
    if(!r.file){ alert('Please upload image for every product'); return; }
  }

  // disable UI
  submitBtn.disabled = true;
  submitBtn.textContent = 'Uploading & Sending...';
  addRowBtn.disabled = true;
  clearBtn.disabled = true;

  try {
    // 1) upload each file to supabase in parallel
    const uploads = await Promise.all(rows.map(async (r) => {
      const fileName = `${Date.now()}_${r.file.name.replace(/\s+/g,'_')}`;
      const up = await supabase.storage.from(BUCKET).upload(fileName, r.file);
      if(up.error) throw up.error;
      const { data } = supabase.storage.from(BUCKET).getPublicUrl(fileName);
      return data.publicUrl;
    }));

    // 2) assemble product_list_html
    let product_list_html = `<div style="font-family:Poppins, Arial, sans-serif; background:#000; color:#fff; padding:12px;">`;
    rows.forEach((r, idx) => {
      const image = uploads[idx];
      const pname = escapeHtml(document.getElementById('name-'+r.id).value.trim());
      const pprice = escapeHtml(document.getElementById('price-'+r.id).value.trim());
      product_list_html += `
        <div style="background:#111;padding:12px;border-radius:10px;margin-bottom:12px;">
          <h3 style="color:${'#d4af37'};margin:0 0 8px">Product ${idx+1}</h3>
          <p style="margin:4px 0"><strong style="color:${'#d4af37'}">Name:</strong> ${pname}</p>
          <p style="margin:4px 0"><strong style="color:${'#d4af37'}">Price:</strong> ₹${pprice}</p>
          <p style="margin:8px 0"><a href="${image}" target="_blank"><img src="${image}" style="max-width:260px;border-radius:8px" /></a></p>
        </div>`;
    });
    product_list_html += `</div>`;

    // 3) send email via EmailJS
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      user_name: userName,
      user_email: userEmail,
      product_list_html: product_list_html,
      year: new Date().getFullYear()
    });

    // 4) redirect to thank you
    window.location.href = 'thankyou-consignment.html';

  } catch (err){
    console.error(err);
    alert('Error sending. See console.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit All';
    addRowBtn.disabled = false;
    clearBtn.disabled = false;
  }
});

/* small helper */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* create initial row */
addNewRow();
</script>
</body>
</html>
